{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="pagetitle">
  <h1>Gestão de Tipos de Evento</h1>
  <br>
  <div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTipoEventoModal">
      <i class="bi bi-plus-circle"></i> Adicionar Tipo
    </button>
  </div>
  <br>

  <section class="section">
    <div class="table-responsive">
      <table class="table table-striped table-hover" id="id_table_tipos_evento">
        <thead class="table-dark">
          <tr>
            <th scope="col">Tipo de Evento</th>
            <th scope="col">Criado em</th>
            <th scope="col">Atualizado em</th>
            <th scope="col">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for tipo in tipos_evento %}
          <tr data-tipo-id="{{ tipo.id }}">
            <td>{{ tipo.tipo_evento }}</td>
            <td>{{ tipo.created|date:"d/m/Y H:i" }}</td>
            <td>{{ tipo.updated|date:"d/m/Y H:i" }}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editTipoEvento({{ tipo.id }})" title="Editar">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteTipoEvento({{ tipo.id }})" title="Excluir">
                <i class="bi bi-trash3-fill"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center text-muted">Nenhum tipo de evento encontrado</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- Modal Adicionar/Editar Tipo de Evento -->
<div class="modal fade" id="addTipoEventoModal" tabindex="-1" aria-labelledby="addTipoEventoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTipoEventoModalLabel">Adicionar Tipo de Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="tipoEventoForm" method="POST">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <label class="form-label">Tipo de Evento *</label>
              <input type="text" class="form-control" name="tipo_evento" id="id_tipo_evento" maxlength="40" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Confirmação de Deleção -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmação de Exclusão</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir este tipo de evento?</p>
        <p class="text-muted small">Esta ação não pode ser desfeita e pode afetar eventos existentes.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Excluir</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
let tipoEventoIdToEdit = null;
let tipoEventoIdToDelete = null;

$(document).ready(function() {
    // Inicializar DataTable
    var table = $('#id_table_tipos_evento').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json"
        },
        "pageLength": 25,
        "order": [[0, "asc"]], // Ordenar por tipo de evento
        "columnDefs": [
            {
                "targets": [3], // Coluna de ações
                "orderable": false
            }
        ]
    });

    // Formulário de tipo de evento
    $('#tipoEventoForm').on('submit', function(e) {
        e.preventDefault();
        saveTipoEvento();
    });

    // Limpar formulário quando modal for fechado
    $('#addTipoEventoModal').on('hidden.bs.modal', function() {
        resetForm();
    });

    // Confirmar exclusão
    $('#confirmDeleteButton').on('click', function() {
        if (tipoEventoIdToDelete) {
            deleteTipoEventoConfirmed();
        }
    });
});

function editTipoEvento(id) {
    tipoEventoIdToEdit = id;
    
    // Buscar dados do tipo de evento
    $.ajax({
        url: '/getTipoEvento/' + id,
        type: 'GET',
        success: function(response) {
            if (response.status === 'success') {
                var tipoEvento = response.tipo_evento;
                
                $('#id_tipo_evento').val(tipoEvento.tipo_evento);
                
                $('#addTipoEventoModalLabel').text('Editar Tipo de Evento');
                $('#addTipoEventoModal').modal('show');
            } else {
                alert('Erro ao carregar dados do tipo de evento: ' + response.message);
            }
        },
        error: function() {
            alert('Erro ao carregar dados do tipo de evento');
        }
    });
}

function saveTipoEvento() {
    var formData = {
        'tipo_evento': $('#id_tipo_evento').val(),
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    };

    var url = tipoEventoIdToEdit ? '/updateTipoEvento/' + tipoEventoIdToEdit : '/addTipoEvento';

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        success: function(response) {
            if (response.status === 'success') {
                alert(response.message);
                $('#addTipoEventoModal').modal('hide');
                location.reload();
            } else {
                alert('Erro: ' + response.message);
            }
        },
        error: function() {
            alert('Erro ao salvar tipo de evento');
        }
    });
}

function deleteTipoEvento(id) {
    tipoEventoIdToDelete = id;
    $('#confirmDeleteModal').modal('show');
}

function deleteTipoEventoConfirmed() {
    $.ajax({
        url: '/deleteTipoEvento/' + tipoEventoIdToDelete,
        type: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.status === 'success') {
                alert(response.message);
                $('#confirmDeleteModal').modal('hide');
                location.reload();
            } else {
                alert('Erro: ' + response.message);
            }
        },
        error: function() {
            alert('Erro ao excluir tipo de evento');
        }
    });
}

function resetForm() {
    $('#tipoEventoForm')[0].reset();
    tipoEventoIdToEdit = null;
    $('#addTipoEventoModalLabel').text('Adicionar Tipo de Evento');
}
</script>
{% endblock %} 